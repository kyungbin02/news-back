name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        working-directory: ./backend
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Generate deployment package
        run: |
          # 배포 디렉토리 생성
          mkdir -p deploy
          
          # JAR 파일 복사 (ZIP 루트에 위치)
          cp backend/build/libs/backend-0.0.1-SNAPSHOT.jar deploy/
          
          # Procfile 복사 (ZIP 루트에 위치)
          cp backend/Procfile deploy/
          
          # .platform 폴더 복사 (Nginx 설정용)
          if [ -d ".platform" ]; then
            cp -r .platform deploy/
          elif [ -d "backend/.platform" ]; then
            cp -r backend/.platform deploy/.platform
          fi
          
          # ZIP 내용 확인 (디버깅용)
          echo "=== 배포 패키지 내용 확인 ==="
          ls -la deploy/
          echo ""
          echo "=== Procfile 내용 확인 ==="
          cat deploy/Procfile
          echo ""
          
          # ZIP 생성 (deploy 디렉토리 내용을 ZIP 루트로)
          cd deploy
          zip -r ../backend/deploy.zip .
          cd ..
          
          # ZIP 파일 내용 확인
          echo "=== ZIP 파일 내용 확인 ==="
          unzip -l backend/deploy.zip | head -20

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v20
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: "myappbd-main"
          environment_name: "Myappbd-main-env"
          region: "ap-northeast-2"
          version_label: "build-${{ github.run_number }}"
          deployment_package: "backend/deploy.zip"

