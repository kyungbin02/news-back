name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        working-directory: ./backend
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Generate deployment package
        run: |
          mkdir -p backend/deploy
          cp backend/build/libs/backend-0.0.1-SNAPSHOT.jar backend/deploy/
          cp backend/Procfile backend/deploy/
          # .platform 폴더도 ZIP에 포함 (Nginx 설정용)
          # 루트 또는 backend 안의 .platform 폴더를 찾아서 복사
          if [ -d ".platform" ]; then
            cp -r .platform backend/deploy/
          elif [ -d "backend/.platform" ]; then
            cp -r backend/.platform backend/deploy/.platform
          fi
          cd backend/deploy
          zip -r ../deploy.zip .

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v20
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: "myappbd-main"
          environment_name: "Myappbd-main-env"
          region: "ap-northeast-2"
          version_label: "build-${{ github.run_number }}"
          deployment_package: "backend/deploy.zip"

