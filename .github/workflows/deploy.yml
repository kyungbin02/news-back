name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        working-directory: ./backend
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Generate deployment package
        run: |
          # JAR 파일 확인
          echo "=== JAR 파일 확인 ==="
          ls -la backend/build/libs/*.jar || echo "JAR 파일 없음!"
          echo ""
          
          # 배포 디렉토리 생성
          mkdir -p deploy
          
          # JAR 파일 복사 (ZIP 루트에 위치, 이름 단순화)
          JAR_FILE=$(ls backend/build/libs/*.jar | grep -v plain | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "❌ JAR 파일을 찾을 수 없습니다!"
            exit 1
          fi
          echo "JAR 파일: $JAR_FILE"
          cp "$JAR_FILE" deploy/backend.jar
          
          # Procfile 복사 (ZIP 루트에 위치)
          cp backend/Procfile deploy/
          # Procfile 형식 검증 및 수정 (줄바꿈 문제 해결)
          sed -i 's/\r$//' deploy/Procfile
          # 빈 줄 제거
          sed -i '/^$/d' deploy/Procfile
          
          # .platform 폴더 복사 (Nginx 설정용) - .ebextensions는 제외
          if [ -d ".platform" ]; then
            cp -r .platform deploy/
          elif [ -d "backend/.platform" ]; then
            cp -r backend/.platform deploy/.platform
          fi
          
          # .ebextensions 폴더가 있다면 제거 (중복 방지)
          if [ -d "deploy/.ebextensions" ]; then
            rm -rf deploy/.ebextensions
          fi
          
          # ZIP 내용 확인 (디버깅용)
          echo ""
          echo "=== 배포 패키지 내용 확인 ==="
          ls -lah deploy/
          echo ""
          echo "=== Procfile 내용 확인 ==="
          cat deploy/Procfile
          echo ""
          echo "=== JAR 파일 크기 확인 ==="
          ls -lh deploy/*.jar
          echo ""
          
          # ZIP 생성 (deploy 디렉토리 내용을 ZIP 루트로)
          cd deploy
          zip -r ../backend/deploy.zip .
          cd ..
          
          # ZIP 파일 내용 확인
          echo "=== ZIP 파일 내용 확인 (상위 30개) ==="
          unzip -l backend/deploy.zip | head -30
          echo ""
          echo "=== ZIP 파일 크기 ==="
          ls -lh backend/deploy.zip

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v20
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: "myappbd-main"
          environment_name: "Myappbd-main-env"
          region: "ap-northeast-2"
          version_label: "build-${{ github.run_number }}"
          deployment_package: "backend/deploy.zip"

